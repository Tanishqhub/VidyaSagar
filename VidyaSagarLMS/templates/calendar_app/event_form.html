{% extends 'dashboard/base.html' %}
{% load calendar_tags %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-calendar-plus"></i> {{ title }}</h1>
    <p class="text-muted">Create or edit calendar events</p>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Event Details</h4>
            </div>
            <div class="card-body">
                <form method="post" id="eventForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">Event Title *</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                <div class="text-danger">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.event_type.id_for_label }}" class="form-label">Event Type *</label>
                                {{ form.event_type }}
                                {% if form.event_type.errors %}
                                <div class="text-danger">{{ form.event_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <div class="text-danger">{{ form.category.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date *</label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                <div class="text-danger">{{ form.start_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.start_time.id_for_label }}" class="form-label">Start Time</label>
                                {{ form.start_time }}
                                {% if form.start_time.errors %}
                                <div class="text-danger">{{ form.start_time.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date</label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}
                                <div class="text-danger">{{ form.end_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.end_time.id_for_label }}" class="form-label">End Time</label>
                                {{ form.end_time }}
                                {% if form.end_time.errors %}
                                <div class="text-danger">{{ form.end_time.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="form-check">
                                {{ form.all_day }}
                                <label class="form-check-label" for="{{ form.all_day.id_for_label }}">
                                    All Day Event
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                {{ form.is_recurring }}
                                <label class="form-check-label" for="{{ form.is_recurring.id_for_label }}">
                                    Recurring Event
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="recurrenceFields" class="row mb-3" style="display: none;">
                        <div class="col-md-4">
                            <label for="{{ form.recurrence_pattern.id_for_label }}" class="form-label">Recurrence Pattern</label>
                            {{ form.recurrence_pattern }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.recurrence_end_date.id_for_label }}" class="form-label">Recurrence End Date</label>
                            {{ form.recurrence_end_date }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.location.id_for_label }}" class="form-label">Location</label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                <div class="text-danger">{{ form.location.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.room.id_for_label }}" class="form-label">Room</label>
                                {{ form.room }}
                                {% if form.room.errors %}
                                <div class="text-danger">{{ form.room.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if user.role in 'manager,admin,superadmin'|split:',' %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.trainers.id_for_label }}" class="form-label">Assign Trainers</label>
                                {{ form.trainers }}
                                {% if form.trainers.errors %}
                                <div class="text-danger">{{ form.trainers.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.students.id_for_label }}" class="form-label">Assign Students</label>
                                {{ form.students }}
                                {% if form.students.errors %}
                                <div class="text-danger">{{ form.students.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'calendar' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle recurrence fields
    const isRecurring = document.getElementById('{{ form.is_recurring.id_for_label }}');
    const recurrenceFields = document.getElementById('recurrenceFields');
    
    function toggleRecurrenceFields() {
        if (isRecurring.checked) {
            recurrenceFields.style.display = 'flex';
        } else {
            recurrenceFields.style.display = 'none';
        }
    }
    
    isRecurring.addEventListener('change', toggleRecurrenceFields);
    toggleRecurrenceFields(); // Initial state
    
    // Set min date to today for start date
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    if (startDateInput) {
        const today = new Date().toISOString().split('T')[0];
        startDateInput.min = today;
    }
    
    // Toggle time fields for all-day events
    const allDayCheckbox = document.getElementById('{{ form.all_day.id_for_label }}');
    const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
    const endTimeInput = document.getElementById('{{ form.end_time.id_for_label }}');
    
    function toggleTimeFields() {
        if (allDayCheckbox.checked) {
            if (startTimeInput) startTimeInput.disabled = true;
            if (endTimeInput) endTimeInput.disabled = true;
        } else {
            if (startTimeInput) startTimeInput.disabled = false;
            if (endTimeInput) endTimeInput.disabled = false;
        }
    }
    
    allDayCheckbox.addEventListener('change', toggleTimeFields);
    toggleTimeFields(); // Initial state
    
    // Form validation
    const form = document.getElementById('eventForm');
    form.addEventListener('submit', function(e) {
        const startDate = document.getElementById('{{ form.start_date.id_for_label }}').value;
        const endDate = document.getElementById('{{ form.end_date.id_for_label }}').value;
        
        if (endDate && new Date(endDate) < new Date(startDate)) {
            e.preventDefault();
            alert('End date cannot be before start date!');
        }
    });
});
</script>

<style>
.form-control, .form-select {
    padding: 8px 12px;
    border-radius: 5px;
    border: 1px solid #ced4da;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

label {
    font-weight: 500;
    margin-bottom: 5px;
}

#recurrenceFields {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}
</style>
{% endblock %}